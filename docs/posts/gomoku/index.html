<!DOCTYPE html>
<html lang='zh' ><meta charset="utf-8">
<meta name="viewport" content="width=device-width">


<title>RGB灯带做棋盘的双人五子棋游戏 | NotEnough</title>

<meta name="generator" content="Hugo Eureka 0.8.2" />
<link rel="stylesheet" href="https://www.notenough.top/css/eureka.min.css">
<script defer src="https://www.notenough.top/js/eureka.min.js"></script>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload"
  href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap"
  as="style" onload="this.onload=null;this.rel='stylesheet'">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/solarized-light.min.css"
   media="print"
  onload="this.media='all';this.onload=null" crossorigin>
<script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js"
   crossorigin></script>

  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/languages/dart.min.js"
     crossorigin></script>

<script defer src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js"
   integrity="sha256-uNYoXefWRqv&#43;PsIF/OflNmwtKM4lStn9yrz2gVl6ymo="  crossorigin></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
   integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3&#43;Aro6EYUG4&#43;cU&#43;KJWu/X"  media="print"
  onload="this.media='all';this.onload=null" crossorigin>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" 
  integrity="sha384-g7c&#43;Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI&#43;sEnkvrMWph2EDg4"  crossorigin></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
   integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC&#43;Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa"  crossorigin></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
        { left: "\\(", right: "\\)", display: false },
        { left: "\\[", right: "\\]", display: true }
      ],
    });
  });
</script>


<script defer src="https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js" 
  integrity="sha256-Zmpaaj&#43;GXFsPF5WdPArSrnW3b30dovldeKsW00xBVwE="  crossorigin></script>


<link rel="icon" type="image/png" sizes="32x32" href="https://www.notenough.top/images/icon_hu64421c6c7700f606f0ad45d807017b09_5843_32x32_fill_box_center_3.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://www.notenough.top/images/icon_hu64421c6c7700f606f0ad45d807017b09_5843_180x180_fill_box_center_3.png">

<meta name="description"
  content="这是我短学期的任务,做的简陋，勉强能实现主要功能，写了技术文档，记录一下。
一、 项目简介
本项目综合 arduino、flutter、node-red 以及 mqtt 协议开发一个可供电脑端和手机端共同游戏的五子棋游戏，并将游戏实时显示在 RGB 灯带组成的棋盘上。">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
      "@type": "ListItem",
      "position": 1 ,
      "name":"Posts",
      "item":"https://www.notenough.top/posts/"},{
      "@type": "ListItem",
      "position": 2 ,
      "name":"RGB灯带做棋盘的双人五子棋游戏",
      "item":"https://www.notenough.top/posts/gomoku/"}]
}
</script>



<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://www.notenough.top/posts/gomoku/"
    },
    "headline": "RGB灯带做棋盘的双人五子棋游戏 | NotEnough","datePublished": "2019-08-26T17:31:22+08:00",
    "dateModified": "2019-08-26T17:31:22+08:00",
    "wordCount":  1395 ,
    "publisher": {
        "@type": "Person",
        "name": "C. Wang",
        "logo": {
            "@type": "ImageObject",
            "url": "https://www.notenough.top/images/icon.png"
        }
        },
    "description": "\u003cp\u003e这是我短学期的任务,做的简陋，勉强能实现主要功能，写了技术文档，记录一下。\u003c\/p\u003e\n\u003ch2 id=\u0022一-项目简介\u0022\u003e一、 项目简介\u003c\/h2\u003e\n\u003cp\u003e本项目综合 arduino、flutter、node-red 以及 mqtt 协议开发一个可供电脑端和手机端共同游戏的五子棋游戏，并将游戏实时显示在 RGB 灯带组成的棋盘上。\u003c\/p\u003e"
}
</script><meta property="og:title" content="RGB灯带做棋盘的双人五子棋游戏 | NotEnough" />
<meta property="og:type" content="article" />


<meta property="og:image" content="https://www.notenough.top/images/icon.png">


<meta property="og:url" content="https://www.notenough.top/posts/gomoku/" />




<meta property="og:description" content="这是我短学期的任务,做的简陋，勉强能实现主要功能，写了技术文档，记录一下。
一、 项目简介
本项目综合 arduino、flutter、node-red 以及 mqtt 协议开发一个可供电脑端和手机端共同游戏的五子棋游戏，并将游戏实时显示在 RGB 灯带组成的棋盘上。" />




<meta property="og:locale" content="zh" />




<meta property="og:site_name" content="NotEnough" />






<meta property="article:published_time" content="2019-08-26T17:31:22&#43;08:00" />


<meta property="article:modified_time" content="2019-08-26T17:31:22&#43;08:00" />



<meta property="article:section" content="posts" />


<meta property="article:tag" content="Flutter" />

<meta property="article:tag" content="Arduino" />

<meta property="article:tag" content="JavaScript" />

<meta property="article:tag" content="HTML" />





<meta property="og:see_also" content="https://www.notenough.top/posts/jsnote/" />

<meta property="og:see_also" content="https://www.notenough.top/posts/flutternote3/" />

<meta property="og:see_also" content="https://www.notenough.top/posts/flutternote2/" />

<meta property="og:see_also" content="https://www.notenough.top/posts/flutternote1/" />

<meta property="og:see_also" content="https://www.notenough.top/posts/htmlnote1/" />



<body class="flex flex-col min-h-screen">
  <header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm">
    <div class="w-full max-w-screen-xl mx-auto"><script>
    let storageColorScheme = localStorage.getItem("lightDarkMode")
    if (((storageColorScheme == 'Auto' || storageColorScheme == null) && window.matchMedia("(prefers-color-scheme: dark)").matches) || storageColorScheme == "Dark") {
        document.getElementsByTagName('html')[0].classList.add('dark')
    }
</script>
<nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0">
    <a href="/" class="mr-6 text-primary-text text-xl font-bold">NotEnough</a>
    <button id="navbar-btn" class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
        <i class="fas fa-bars"></i>
    </button>

    <div id="target"
        class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20">
        <div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0">
            <a href="/#about" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  mr-4">About</a>
            <a href="/posts/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  selected-menu-item  mr-4">Posts</a>
            <a href="/docs/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  mr-4">Docs</a>
        </div>

        <div class="flex">
            <div class="relative pt-4 md:pt-0">
                <div class="cursor-pointer hover:text-eureka" id="lightDarkMode">
                    <i class="fas fa-adjust"></i>
                </div>
                <div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id="is-open">
                </div>
                <div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40"
                    id='lightDarkOptions'>
                    <span class="px-4 py-1 hover:text-eureka" name="Light">浅色</span>
                    <span class="px-4 py-1 hover:text-eureka" name="Dark">深色</span>
                    <span class="px-4 py-1 hover:text-eureka" name="Auto">自动</span>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id="is-open-mobile">
    </div>

</nav>
<script>
    
    let element = document.getElementById('lightDarkMode')
    if (storageColorScheme == null || storageColorScheme == 'Auto') {
        document.addEventListener('DOMContentLoaded', () => {
            window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change', switchDarkMode)
        })
    } else if (storageColorScheme == "Light") {
        element.firstElementChild.classList.remove('fa-adjust')
        element.firstElementChild.setAttribute("data-icon", 'sun')
        element.firstElementChild.classList.add('fa-sun')
    } else if (storageColorScheme == "Dark") {
        element.firstElementChild.classList.remove('fa-adjust')
        element.firstElementChild.setAttribute("data-icon", 'moon')
        element.firstElementChild.classList.add('fa-moon')
    }

    document.addEventListener('DOMContentLoaded', () => {
        getcolorscheme();
        switchBurger();
    });
</script>
</div>
  </header>
  <main class="flex-grow pt-16">
    <div class="pl-scrollbar">
      <div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto">


<div class="grid grid-cols-2 lg:grid-cols-8 gap-4 lg:pt-12">
    <div
        class="col-span-2 lg:col-start-2 lg:col-span-6 bg-secondary-bg rounded px-6 py-8">
        <h1 class="font-bold text-3xl text-primary-text">RGB灯带做棋盘的双人五子棋游戏</h1>
        <div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text">
    <div class="mr-6 my-2">
        <i class="fas fa-calendar mr-1"></i>
        <span>2019-08-26</span>
    </div>
    <div class="mr-6 my-2">
        <i class="fas fa-clock mr-1"></i>
        <span>7分钟阅读时长</span>
    </div>
    
    
    <div class="mr-6 my-2">
        <i class="fas fa-folder mr-1"></i>
        
        <a href="https://www.notenough.top/categories/project/" class="hover:text-eureka">project</a>
        
    </div>
    

    
</div>
        
        
        

        <div class="content">
            <p>这是我短学期的任务,做的简陋，勉强能实现主要功能，写了技术文档，记录一下。</p>
<h2 id="一-项目简介">一、 项目简介</h2>
<p>本项目综合 arduino、flutter、node-red 以及 mqtt 协议开发一个可供电脑端和手机端共同游戏的五子棋游戏，并将游戏实时显示在 RGB 灯带组成的棋盘上。</p>
<h2 id="二-项目准备">二、 项目准备</h2>
<p>所需的材料：ESP32 一个、WS2812 灯带共 225 个灯珠、杜邦线若干、5v 电源、变压箱、面包板。</p>
<p>所做的准备：搭建 MQTT 服务器、arduino 开发环境及 FastLED 库，Flutter 应用框架，node-red 节点开发环境。</p>
<h2 id="三-棋盘的制作">三、 棋盘的制作</h2>
<p><img src="https://github.com/AthleticsNero/AthleticsNero.github.io/blob/master/2019/08/26/gomoku/led.jpg?raw=true" alt="">
灯带走单总线协议，为了做成 15*15 的棋盘，需要在每 15 个灯珠处剪断，并焊接连接。并且每两行单独供电，防止走单总线串联而产生供电不足的问题，（如上图所示，第二条和第三条间只焊接数据线，供电线在第三条上连接面包板），面包板处供电连接变压箱，设定 5V，棋盘首部数据传输线连接 esp32 的 12 号引脚（可自行设定），esp32 由外部电源供电。</p>
<h2 id="四-arduino-的开发">四、 Arduino 的开发</h2>
<p>这里使用 ESP32 开发板，开发前请先下载并选用该开发板。</p>
<p>加载将使用的库：</p>
<ol>
<li>FastLED 库控制灯带的显示。</li>
<li>WiFi 库将 ESP32 连接到热点。</li>
<li>PubSubClient 库用于 mqtt 通信。</li>
</ol>
<h3 id="1-wifi-的连接">1. Wifi 的连接</h3>
<pre><code class="language-c">#include&lt;WiFi.h&gt;//先导入库
const char* ssid = &quot;xxxx&quot;;//WiFi的ssid和密码常量定义
const char* password = &quot;xxxx&quot;;
void setup(){
    Serial.begin(115200);
 setup_wifi();//初始化函数调用启动wifi函数
}
void setup_wifi(){
    delay(10);
    Serial.println();
    Serial.print(&quot;Connecting to &quot;);
    Serial.println(ssid);
    WiFi.begin(ssid,password);
    while(WiFi.status()!=WL_CONNECTED){
        delay(500);
        Serial.print(&quot;.&quot;);
    }
    Serial.println(&quot;&quot;);
    Serial.println(&quot;WiFi connected&quot;);//连接成功后显示IP信息
    Serial.println(&quot;IP address:&quot;);
    Serial.println(WiFi.localIP());
}
</code></pre>
<h3 id="2-mqtt-服务器的连接">2. MQTT 服务器的连接</h3>
<pre><code class="language-c">#include&lt;PubSubClient.h&gt;
const char* mqtt_server = &quot;xxxx&quot;;
WiFiClient espClient;
PubSubClient client(espClient);
Void setup(){
    client.setServer(mqtt_server,1883);
    client.setCallback(callback);//设置回调函数，每次接收到信//息都执行callback函数
}
void reconnect(){
    while(!client.connected()){
        Serial.print(&quot;Attempting MQTT connection...&quot;);
        if(client.connect(&quot;ESP32Client&quot;)){
            Serial.println(&quot;connected&quot;);
            client.subscribe(&quot;player2&quot;);//订阅两个玩家的主题
        client.subscribe(&quot;player1&quot;);
        }else{
            Serial.print(&quot;failed,rc=&quot;);
            Serial.print(client.state());
            Serial.println(&quot; try again in 5 seconds&quot;);
            delay(5000);
        }
    }
}
void loop() {
    if(!client.connected()){//客户端连接断开后执行重连
        reconnect();
    }
    client.loop();
}
</code></pre>
<h3 id="3-回调函数">3. 回调函数</h3>
<p>回调函数中要根据接收到的消息来控制灯的显示。</p>
<pre><code class="language-c">#include&lt;FastLED.h&gt;
#define PIN 12//引脚
#define MAXLED 225//最大灯数
CRGB leds[MAXLED];//实例化
static int exist[225];//记录棋子信息，避免重复下棋
void setup(){
    FastLED.addLeds&lt;WS2812,PIN, GRB&gt;(leds, MAXLED);
}
void callback(char* topic,byte* payload,unsigned int length){
    int pos=0,j=0;  //pos代表棋子位置数字
    while(j&lt;length){ //这一段的处理将字节类型的传入数据转化成int类型数字
        pos=pos*10+(int)((char)payload[j]-'0');
        Serial.print((char)payload[j]);
        j++;
    }
    if(pos==255){//设定玩家一赢时传入255
        fill_solid(leds,MAXLED, CRGB::Red);//将灯全部置为红色表面玩家一胜利
    }else if(pos==256){//玩家二赢时传入256
        fill_solid(leds,MAXLED, CRGB::Green);
    }else{
/*因为灯带数据传输的方向是一条线，所以会导致第15盏灯在第二行的最后一个位置，第二行的第一盏灯却是第29盏灯，这点在处理时必须注意逻辑*/
        if((pos/15)%2==1){
            pos=(pos/15+1)*15-1-(pos%15);
        }
//如果玩家传入的位置还未下子，就该点亮起红色且加入存在信息，再次下同样位置就不会执行
        if(strcmp(topic,&quot;player1&quot;)==0&amp;&amp;exist[pos]==0){
            leds[pos]=CRGB(255,0,0);
            exist[pos]=1;
        }else if(strcmp(topic,&quot;player2&quot;)==0&amp;&amp;exist[pos]==0){
            leds[pos]=CRGB(0,255,0);
            exist[pos]=1;
        }
    }
    FastLED.show();//输出灯的信息
    delay(1000);
}
</code></pre>
<p>全部代码如上，可借助串口监视器观察是否连接成功以及棋子的位置信息。</p>
<h2 id="五-ai-node-上-dashboard-的开发">五、 AI-Node 上 Dashboard 的开发</h2>
<p><img src="https://github.com/AthleticsNero/AthleticsNero.github.io/blob/master/2019/08/26/gomoku/flow.png?raw=true" alt="">
棋盘节点接收 player2（手机端）的 mqtt 消息，并传出以 player1 作主题的 mqtt 消息。
<img src="https://github.com/AthleticsNero/AthleticsNero.github.io/blob/master/2019/08/26/gomoku/chessboard1.png?raw=true" alt="">
这是最终做成的棋盘，点击格子下棋，player1 的棋子红色，player2 的棋子绿色。</p>
<h3 id="1-棋盘绘制">1. 棋盘绘制</h3>
<pre><code class="language-html">&lt;div id=&quot;table_content&quot; style=&quot;width: 550px; margin: 0 auto;&quot;&gt;&lt;/div&gt;
</code></pre>
<p>这是整体棋盘，设定了宽度，内部细节写在 script 标签里，目的是为了动态产生带独特 ID（位置信息）的表格元素。</p>
<pre><code class="language-html">&lt;button
  type=&quot;submit&quot;
  id=&quot;enda&quot;
  style=&quot;width:100px;margin-left:350px;margin-top:50px;display:none&quot;
  ng-click=&quot;send({payload:'255'})&quot;
&gt;
  结束游戏
&lt;/button&gt;
&lt;button
  type=&quot;submit&quot;
  id=&quot;endb&quot;
  style=&quot;width:100px;margin-left:350px;margin-top:50px;display:none&quot;
  ng-click=&quot;send({payload:'256'})&quot;
&gt;
  结束游戏
&lt;/button&gt;
</code></pre>
<p>两个结束按钮，当某一玩家获胜时出现对应按钮，用于宣告胜利，传给 esp32 胜利信息。通过 display：none 实现在游戏中隐藏，获胜时修改 display 值便可使其显现。</p>
<pre><code class="language-html">&lt;script type=&quot;text/javascript&quot;&gt;
var div1 = document.getElementById(&quot;table_content&quot;);
var code = '&lt;table border=\&quot;1px\&quot;' + 'style=\&quot;border-collapse: collapse;\&quot;&gt;';
var i,j;
for (i=0;i &lt; 15 ;i++ ){
    code+= &quot;&lt;tr&gt;&quot;;
    for (j=0;j &lt; 15 ;j++ ){
        var id;
        id = i*15+j;
//每个格子带上id值，单击发送数据即id值，同时调用clickBorder1函数，改变格子颜色。
        code += &quot;&lt;td width=\&quot;30px\&quot; height=\&quot;30px\&quot; id=\&quot;&quot; + id + &quot;\&quot;ng-click=\&quot;send({payload:&quot;+id+&quot;})\&quot; onclick='clickBorder1(&quot; + id + &quot;);'&gt;&quot;;
        code += &quot;&lt;/td&gt;&quot;;
    }
    code+=&quot;&lt;/tr&gt;&quot;;
}
    code += &quot;&lt;/table&gt;&quot;;
    div1.innerHTML = code;
</code></pre>
<p>将 html 标签写在 js 中，更加灵活便捷。</p>
<h3 id="2-落子函数">2. 落子函数</h3>
<p>（以玩家 1 为例，玩家 2 同理）</p>
<pre><code class="language-javascript">var ids = new Array() //该数组记录棋格上有无棋子
function clickBorder1(id) {
  for (var i = 0; i &lt; ids.length; i++) {
    if (ids[i] == id) {
      alert('此处已落子！')
      return
    }
  }
  document.getElementById(id).style.background = '#f00'
  document.getElementById(id).style.color = '#f00'
  document.getElementById(id).innerHTML = 'O'
  //用O和X表示棋子信息，方便判断胜利条件，设定字体颜色和背景相同即可。
  ids.push(id) //用ids数组记录棋格棋子有无
  iswina(Math.round(id / 15), Math.round(id % 15))
  //该函数判断是否胜利，参数为此棋子的行列位置。
}
</code></pre>
<h3 id="3-胜利判断">3. 胜利判断</h3>
<p>每次记录最后一个下的棋子的行列位置，通过判断其八个方向有无足够棋子达成五连珠来判断胜利。</p>
<pre><code class="language-javascript">function iswina(i, j) {
  var count = [0, 0, 0, 0, 0, 0, 0, 0] //各个方向已有相邻棋子数
  var state = [1, 1, 1, 1, 1, 1, 1, 1] //各个方向若无子或其他子就赋值为2终止该方向的判定。
  for (var step = 1; step &lt; 5; step++) {
    //设定步长，最多四格
    if (state[0] == 1 &amp;&amp; i - step &gt;= 0 &amp;&amp; j - step &gt;= 0) {
      if (
        document.getElementById((i - step) * 15 + j - step).innerHTML == 'O'
      ) {
        count[0]++
      } else {
        state[0] = 2
      }
    } //左上
    if (state[1] == 1 &amp;&amp; i - step &gt;= 0) {
      if (document.getElementById((i - step) * 15 + j).innerHTML == 'O') {
        count[1]++
      } else {
        state[1] = 2
      }
    } //上
    if (state[2] == 1 &amp;&amp; i - step &gt;= 0 &amp;&amp; j + step &lt; 15) {
      if (
        document.getElementById((i - step) * 15 + j + step).innerHTML == 'O'
      ) {
        count[2]++
      } else {
        state[2] = 2
      }
    } //右上
    if (state[3] == 1 &amp;&amp; j + step &lt; 15) {
      if (document.getElementById(i * 15 + j + step).innerHTML == 'O') {
        count[3]++
      } else {
        state[3] = 2
      }
    } //右
    if (state[4] == 1 &amp;&amp; i + step &lt; 15 &amp;&amp; j + step &lt; 15) {
      if (
        document.getElementById((i + step) * 15 + j + step).innerHTML == 'O'
      ) {
        count[4]++
      } else {
        state[4] = 2
      }
    } //右下
    if (state[5] == 1 &amp;&amp; i + step &lt; 15) {
      if (document.getElementById((i + step) * 15 + j).innerHTML == 'O') {
        count[5]++
      } else {
        state[5] = 2
      }
    } //下
    if (state[6] == 1 &amp;&amp; i + step &lt; 15 &amp;&amp; j - step &gt;= 0) {
      if (
        document.getElementById((i + step) * 15 + j - step).innerHTML == 'O'
      ) {
        count[6]++
      } else {
        state[6] = 2
      }
    } //左下
    if (state[7] == 1 &amp;&amp; j - step &gt;= 0) {
      if (document.getElementById(i * 15 + j - step).innerHTML == 'O') {
        count[7]++
      } else {
        state[7] = 2
      }
    } //左
  }
  //同一条线加上该子，大于等于5个即胜利
  if (
    count[0] + count[4] + 1 &gt;= 5 ||
    count[1] + count[5] + 1 &gt;= 5 ||
    count[2] + count[6] + 1 &gt;= 5 ||
    count[3] + count[7] + 1 &gt;= 5
  ) {
    alert('五连珠，电脑胜')
    document.getElementById('enda').style.display = 'block'
    //跳出胜利信息，并出现结束游戏按钮
  }
  return
}
</code></pre>
<h3 id="4-作用域">4. 作用域</h3>
<pre><code class="language-javascript">;(function (scope) {
  scope.$watch('msg.payload', function (newVal, oldVal) {
    console.log('- Scope.msg -')
    console.dir(scope.msg)
    clickBorder2(scope.msg['payload'])
    //接收玩家二传入的信息
  })
})(scope)
</code></pre>
<h2 id="六-flutter-应用的开发">六、 Flutter 应用的开发</h2>
<h3 id="1-mqtt-依赖">1. mqtt 依赖</h3>
<p>首先新建一个项目，在 pubspec.yaml 文件 dependencies 中加入 mqtt 应用依赖</p>
<blockquote>
<p>mqtt_client: ^5.5.3</p>
</blockquote>
<p>然后点击右上角 Package get 获取相关的依赖.</p>
<p>完成之后在 lib 目录下新建一个 package，并且新建一个 dart 文件 message.dart,在里面黏上下面的代码：</p>
<pre><code class="language-dart">import 'package:mqtt_client/mqtt_client.dart' as mqtt;

class Message {
 final String topic;
 final String message;
 final mqtt.MqttQos qos;

 Message({this.topic, this.message, this.qos});
}
</code></pre>
<p>这个是一个 mqtt 消息的类，里面有一个消息的主题、内容和 Qos。</p>
<h3 id="2-导入相关库">2. 导入相关库</h3>
<pre><code class="language-dart">import 'package:flutter/material.dart';
import 'package:mqtt_client/mqtt_client.dart' as mqtt;
import 'dart:async';
import 'models/message.dart';
import 'btnsingle.dart';//定义棋格类的文件，后面编写
</code></pre>
<pre><code class="language-dart">void main() =&gt; runApp(MyApp());
//箭头函数运行Myapp()
class MyApp extends StatelessWidget{
@override
Widget build(BuildContext context) {
   return MaterialApp(
     debugShowCheckedModeBanner: false,
     title: 'Gomoku',
     home: MyHomePage(title:'Gomoku'),
   );
 }
}
class MyHomePage extends StatefulWidget{
 MyHomePage({Key key,this.title}) : super(key:key);
 final String title;
 @override
_MyHomePageState createState() =&gt; _MyHomePageState();
}
//创建了_MyHomePageState这个state，接下来编写其内容
class _MyHomePageState extends State&lt;MyHomePage&gt;{}
</code></pre>
<p>接下来的内容都写在_MyHomePageState 中</p>
<h3 id="2-定义棋格">2. 定义棋格</h3>
<p><img src="https://github.com/AthleticsNero/AthleticsNero.github.io/blob/master/2019/08/26/gomoku/%E6%89%8B%E6%9C%BA1.png?raw=true" alt="">
与 dashboard 上每个格子带 id 相同，这里的每个格子也都有 id 值，在批量生成棋格的时候，我选择了二维数组，以行为单位，每行带 15 格，共 15 行。
单独写个 dart 文件来定义棋格类。</p>
<pre><code class="language-dart">import 'package:flutter/material.dart';
int chose;
String come;
bool luozi;//是否有落子，用于判断玩家取消下子位置
class BtnSingle extends StatefulWidget {
  //传入参数isAnchoosed，如果为真，则代表玩家一的棋子
  //参数isChoosed如果为真，则代表玩家二的棋子
  BtnSingle({ Key key,this.id,this.isAnchoosed}) : super(key: key);
  final int id;
  bool isChoosed = false;
  final bool isAnchoosed ;
  @override
  _BtnSingle createState() =&gt; new _BtnSingle();
}
class _BtnSingle extends State&lt;BtnSingle&gt; {
  @override
  Widget build(BuildContext context) {
    return
      new Container(
        width: 26,
        height: 26,
        color: Color(0xFFFFFFFF),
        child:new FlatButton(
//棋格无人选中为白色，玩家二选中为绿色，玩家一所下为红色
        color: widget.isChoosed ? Color(0xFF00FF00):(widget.isAnchoosed?Color(0xFFFF0000):Color(0xFFFFFFFF)),
            onPressed: (){
                setState(() {
                    chose = widget.id;//获取该子位置
                    widget.isChoosed = !widget.isChoosed;//更改选中标记
                    if(widget.isChoosed) luozi=true;//如果当前选中状态，标记准备落子
                    else luozi=false;
                });
            },
              shape: RoundedRectangleBorder(
                  side: BorderSide(
                      color: Color(0xFF000000),
                      style: BorderStyle.solid,width: 1
                  )
              ),
            ),
      );
  }
}
//生成单行棋格，列表类型
//isAnchoosed是传入的bool类型参数，若为真代表则是player1所下，初始化都赋值为false
List&lt;BtnSingle&gt; initBtnSingle(int i){
  List&lt;BtnSingle&gt; listbtn = new List();
  int j;
  for(j=0;j&lt;15;j++){
    listbtn.add(new BtnSingle(id: i*15+j,isAnchoosed:false));
  }
  return listbtn;
}
List&lt;List&lt;BtnSingle&gt;&gt; initBtnRow(){
  List&lt;List&lt;BtnSingle&gt;&gt; listrow = new List();
  for(int i=0;i&lt;15;i++){
    listrow.add(initBtnSingle(i));
  }
  return listrow;
}
</code></pre>
<h3 id="3-生成_myhomepagestate-内棋盘">3. 生成_MyHomePageState 内棋盘</h3>
<pre><code class="language-dart">@override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(widget.title),
      ),
      body: (
          Column(
            children: &lt;Widget&gt;[
//每一行都是列表，内有15个棋格
              new Row(
                children: list[0]
              ),
              ....//重复13个，只改变list后面数字就行
              new Row(
                children: list[14]
              ),
              new Wrap(
                children: &lt;Widget&gt;[
                  new Container(
                    padding: EdgeInsets.fromLTRB(75, 4, 20, 4),
                    child:
//确定按钮，触碰并不代表落子，为的是防止误触，只有在选中后再按确定才算落子。
                    RaisedButton(
                        child: Text('确定'),
                        onPressed: () {
                          if(luozi){//确定在此处下子
                            _pubMsg = chose.toString();
                            _pubMessage();
                          }
                        }
                    ),
                  ),
                  new Container(
                    padding: EdgeInsets.fromLTRB(20, 4, 100, 4),
//接收按钮启动监听，在游戏开始时按下
                    child:RaisedButton(
                      child: Text('接收'),
                      onPressed: (){
                        _subMessage();
                      },
                    )
                  )
                ],
              ),
                ],
              )
          )
      );
  }

</code></pre>
<h3 id="4-引入-mqtt-相关参数">4. 引入 mqtt 相关参数</h3>
<pre><code class="language-dart">String _pubTopic = 'player2';//作为player2发布消息
String _pubMsg;//发布消息的内容是字符串类型
String _subTopic = 'player1';//订阅player1的消息
bool _retainValue = false;
ScrollController subMsgScrollController = new ScrollController();
String broker = 'xxxx';//xxxx改为mqtt服务器地址
mqtt.MqttClient client;
mqtt.MqttConnectionState connectionState;
StreamSubscription subscription;
List&lt;Message&gt; messages = &lt;Message&gt;[];
@override
void initState(){
   super.initState();
   _connect();
}
//初始化函数，执行_connect()连接
void _connect() async{
    //client连接的初始化配置
    //默认端口1883，如果不是1883就采用
    //client = mqtt.MqttClient.withPort(broker, '',1883);
    client = mqtt.MqttClient(broker,'');
    client.logging(on: true);
    client.keepAlivePeriod = 30;
    client.onDisconnected = _onDisconnected;
    final mqtt.MqttConnectMessage connMess = mqtt.MqttConnectMessage()
        .withClientIdentifier('webberFlutter')//连接mqtt使用的id
        .startClean()
        .keepAliveFor(30)
        .withWillTopic('willtopic')
        .withWillMessage('My Will message')
        .withWillQos(mqtt.MqttQos.atLeastOnce);
    print('MQTT client connecting....');
    client.connectionMessage = connMess;
    try {
      await client.connect();
    } catch (e) {
      print(e);
      _disconnect();
    }
    if (client.connectionState == mqtt.MqttConnectionState.connected) {
      print('MQTT client connected');
      setState(() {
        connectionState = client.connectionState;
      });
    } else {
      print('ERROR: MQTT client connection failed - '
          'disconnecting, state is ${client.connectionState}');
      _disconnect();
    }
    subscription = client.updates.listen(_onMessage);
  }
//处理连接失败的情况
  void _disconnect() {
    client.disconnect();
    _onDisconnected();
  }
  void _onDisconnected() {
    setState(() {
      connectionState = client.connectionState;
      client = null;
      subscription.cancel();
      subscription = null;
    });
    print('MQTT client disconnected');
}
//_onMessage函数处理传入的信息
 void _onMessage(List&lt;mqtt.MqttReceivedMessage&gt; event) {
    print(event.length);
    print(event[0].topic);
    final mqtt.MqttPublishMessage recMess = event[0].payload as mqtt.MqttPublishMessage;
    final String message = mqtt.MqttPublishPayload.bytesToStringAsString(recMess.payload.message);
    print('MQTT message: topic is &lt;${event[0].topic}&gt;, '
        'payload is &lt;-- ${message} --&gt;');
    print(client.connectionState);
    setState(() {
        if(event[0].topic=='player1'){
          come = message;
          print(int.parse(come));
          for(int i=0;i&lt;225;i++){
     if(int.parse(come)==list[i~/15][i%15].id&amp;&amp;!list[i~/15][i%15].isChoosed){
              BtnSingle btnSingle = new BtnSingle(id:int.parse(come) ,isAnchoosed: true);
              print(list[i~/15][i%15].id);
              print(&quot;i am here!&quot;);
              print(list[i~/15][i%15].isAnchoosed);
              list[i~/15][i%15] = btnSingle;
              print(list[i~/15][i%15].isAnchoosed);
//接收到玩家一棋子信息后，直接替换棋格，其isAnchoosed值为真，代表玩家一所下
            }
          }
        }
    });
  }
 void _subMessage(){
    //开始接收subtopic的submessage
      print(&quot;on sub message&quot;);
      if(connectionState == mqtt.MqttConnectionState.connected){
        setState(() {
          print('subscribe to ${_subTopic}');
          client.subscribe(_subTopic, mqtt.MqttQos.exactlyOnce);
        });
    }
  }
  void _pubMessage(){
    //发布消息
      final mqtt.MqttClientPayloadBuilder builder =
      mqtt.MqttClientPayloadBuilder();
      builder.addString(_pubMsg);
      print(&quot;pub message ${_pubTopic}:${_pubMsg}&quot;);
      client.publishMessage(
        _pubTopic,
        mqtt.MqttQos.values[0],
        builder.payload,
        retain: _retainValue,
      );
  }
</code></pre>
<p>至此 flutter 应用开发完毕。
启动 APP 和 node-red，给 esp32 通电并连接棋盘，保证 wifi 和 mqtt 连接都成功的情况下，便可以进行五子棋游戏。</p>
        </div>
        
        <div class="my-4">
    
    <a href="https://www.notenough.top/tags/flutter/" class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#Flutter</a>
    
    <a href="https://www.notenough.top/tags/arduino/" class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#Arduino</a>
    
    <a href="https://www.notenough.top/tags/javascript/" class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#JavaScript</a>
    
    <a href="https://www.notenough.top/tags/html/" class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#HTML</a>
    
</div>
        
        
        


        
        
        
        
<div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t">
    <div>
        
        <span class="block font-bold">上一页</span>
        <a href="https://www.notenough.top/posts/python%E7%88%AC%E5%8F%96csdn/" class="block">Python爬取用户所有博客</a>
        
    </div>
    <div class="md:text-right mt-4 md:mt-0">
        
        <span class="block font-bold">下一页</span>
        <a href="https://www.notenough.top/posts/ubuntu2/" class="block">ubuntu安装卡死及关机卡死解决方法</a>
        
    </div>
</div>

        



    </div>
    

    
    
    <div
        class="col-span-2 lg:col-start-2 lg:col-span-6 bg-secondary-bg rounded p-6">
        <h2 class="text-lg font-semibold mb-4">相关</h2>
        <div class="content">
            
            <a href="https://www.notenough.top/posts/jsnote/">JavaScript基础</a>
            <br />
            
            <a href="https://www.notenough.top/posts/flutternote3/">FlutterNote3</a>
            <br />
            
            <a href="https://www.notenough.top/posts/flutternote2/">FlutterNote2</a>
            <br />
            
            <a href="https://www.notenough.top/posts/flutternote1/">FlutterNote1</a>
            <br />
            
            <a href="https://www.notenough.top/posts/htmlnote1/">html超文本标记语言笔记</a>
            <br />
            
        </div>
    </div>
    
</div>
<script>
    document.addEventListener('DOMContentLoaded', ()=>{
        hljs.initHighlightingOnLoad();
    })
</script>

      </div>
    </div>
    
  </main>
  <footer class="pl-scrollbar">
    <div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b">
    <p class="text-sm text-tertiary-text"> Powered by the <a href="https://github.com/wangchucheng/hugo-eureka" class="hover:text-eureka">Eureka</a> theme for <a href="https://gohugo.io" class="hover:text-eureka">Hugo</a></p>
</div></div>
  </footer>
</body>

</html>